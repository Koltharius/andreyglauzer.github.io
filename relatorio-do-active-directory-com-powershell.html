
<!DOCTYPE html>
<html>
  <head>
	<!-- Meta -->
	<meta charset="UTF-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
	<meta name="generator" content="Jekyll">

	<title>Relatório do Active Directory com Powershell | Andrey Glauzer | Analista de Suporte / Analista de Segurança da Informação em Barueri/SP</title>
	<link rel="stylesheet"  href="/css/font-awesome/css/font-awesome.min.css">

	<!-- CSS & fonts -->
	<link rel="stylesheet" href="/css/main.css">
	<link href="//fonts.googleapis.com/css?family=Suez+One|Ubuntu:300,400,500,700" rel="stylesheet" data-n-head="true">

	<!-- RSS -->
	<link href="/atom.xml" type="application/atom+xml" rel="alternate" title="ATOM Feed" />

	<!-- Icons -->

	<link rel="apple-touch-icon" sizes="57x57" href="/img/logo/apple-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60" href="/img/logo/apple-icon-60x60.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/img/logo/apple-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76" href="/img/logo/apple-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114" href="/img/logo/apple-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120" href="/img/logo/apple-icon-120x120.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/img/logo/apple-icon-144x144.png">
	<link rel="apple-touch-icon" sizes="152x152" href="/img/logo/apple-icon-152x152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="/img/logo/apple-icon-180x180.png">
	<link rel="icon" type="image/png" sizes="192x192"  href="/img/logo/android-icon-192x192.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/img/logo/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="96x96" href="/img/logo/favicon-96x96.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/img/logo/favicon-16x16.png">
	<link rel="manifest" href="/img/logo/manifest.json">
	<meta name="msapplication-TileColor" content="#ffffff">
	<meta name="msapplication-TileImage" content="/img/logo/ms-icon-144x144.png">
	<meta name="theme-color" content="#ffffff">

	<!-- Meta tags -->
	<meta data-n-head="true" charset="utf-8">
   	<meta data-n-head="true" content="IE=edge" http-equiv="X-UA-Compatible">
   	<meta data-n-head="true" content="width=device-width,minimum-scale=1,initial-scale=1,maximum-scale=5,user-scalable=yes" name="viewport">
	<meta data-n-head="true" content="pt_BR" name="og:locale">
	<meta data-n-head="true" content="index,follow" name="googlebot">
	<meta data-n-head="true" content="index,follow,noodp" name="robots">
	<meta data-n-head="true" content="#006fb6" name="theme-color">
	<meta data-n-head="true" content="summary_large_image" name="twitter:card">
	<meta data-n-head="true" content="@nglauzer" name="twitter:site">
	<meta data-n-head="true" content="Brazil" name="country">
	<meta data-n-head="true" content="7 days" name="revisit-after">
	<meta data-n-head="true" content="yes" name="mobile-web-app-capable">
	<meta data-n-head="true" content="Andrey Glauzer | Analista de Suporte / Analista de Segurança da Informação em Barueri/SP" name="application-name">
	<meta data-n-head="true" content="Visual Studio Code v1.17" name="generator">
	<meta data-n-head="true" content="/browserconfig.xml" name="msapplication-config">
	<meta data-n-head="true" content="profile" data-hid="og:type" property="og:type">
	<meta data-n-head="true" content="Andrey Glauzer | Analista de Suporte / Analista de Segurança da Informação em Barueri/SP" data-hid="og:title" property="og:title">
	<meta data-n-head="true" content="https://andreyglauzer.com" data-hid="og:url" property="og:url">
	<meta data-n-head="true" content="https://andreyglauzer.com/img/screen/social.jpg" data-hid="og:image" property="og:image">
	<meta data-n-head="true" content="Andrey Glauzer | Analista de Suporte / Analista de Segurança da Informação em Barueri/SP" name="description" data-hid="description">
	<meta data-n-head="true" content="barueri,são paulo,analista de suporte,analista de segurança da informação,andrey,glauzer" name="keyword" data-hid="keyword">
	<meta data-n-head="true" content="Andrey Glauzer | Analista de Suporte / Analista de Segurança da Informação em Barueri/SP" name="twitter:title" data-hid="twitter:title">
	<meta data-n-head="true" content="Andrey Glauzer | Analista de Suporte / Analista de Segurança da Informação em Barueri/SP" name="twitter:description" data-hid="twitter:description">
	<meta data-n-head="true" content="https://andreyglauzer.com/img/screen/social.jpg" name="twitter:image" data-hid="twitter:image">
	<meta data-n-head="true" content="Andrey Glauzer | Analista de Suporte / Analista de Segurança da Informação em Barueri/SP" name="twitter:image:alt" data-hid="twitter:image:alt">
	<meta data-n-head="true" data-hid="canonical" href="https://andreyglauzer.com" rel="canonical">
</head>


  <body>
    <div id="wrap">
        <!-- IF para definir o HEADER -->
        
          <header class="header">
   <a href="/" class="header__back nuxt-link-active">
      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left">
         <line x1="20" y1="12" x2="4" y2="12"></line>
         <polyline points="10 18 4 12 10 6"></polyline>
      </svg>
      <span>Ir para Home</span>
   </a>
   <div>
      <nav role="navigation" class="navbar">
         <ul role="menu" class="navbar__nav">
            <li class="navbar__nav-item navbar__nav-item--search">
               <div class="inner search__box">
  <a href="#modal" role="link" class="navbar__nav-link">
    <svg  xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="#ffffff">
      <title class="search-icon">Search icon</title>
      <path  fill-rule="evenodd" d="M15.7 13.3l-3.81-3.83A5.93 5.93 0 0 0 13 6c0-3.31-2.69-6-6-6S1 2.69 1 6s2.69 6 6 6c1.3 0 2.48-.41 3.47-1.11l3.83 3.81c.19.2.45.3.7.3.25 0 .52-.09.7-.3a.996.996 0 0 0 0-1.41v.01zM7 10.7c-2.59 0-4.7-2.11-4.7-4.7 0-2.59 2.11-4.7 4.7-4.7 2.59 0 4.7 2.11 4.7 4.7 0 2.59-2.11 4.7-4.7 4.7z"></path>
    </svg>
  </a>
</div>
<div class="modal" id="modal">
  <div class="search__box">
    <a class="modal--close" href="#">&times;</a>
      <svg data-v-38ac2332="" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="#404756" class="search__icon"><title data-v-38ac2332="" id="searchicon">Search icon</title><path data-v-38ac2332="" fill-rule="evenodd" d="M15.7 13.3l-3.81-3.83A5.93 5.93 0 0 0 13 6c0-3.31-2.69-6-6-6S1 2.69 1 6s2.69 6 6 6c1.3 0 2.48-.41 3.47-1.11l3.83 3.81c.19.2.45.3.7.3.25 0 .52-.09.7-.3a.996.996 0 0 0 0-1.41v.01zM7 10.7c-2.59 0-4.7-2.11-4.7-4.7 0-2.59 2.11-4.7 4.7-4.7 2.59 0 4.7 2.11 4.7 4.7 0 2.59-2.11 4.7-4.7 4.7z"></path></svg>
      <input type="text" id="search-input" class="search__input" placeholder="Digite algo..." autofocus>

      <ul id="results-container"></ul>
  </div>
</div>
<script src="/js/simple-jekyll-search.min.js"></script>
<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('results-container'),
  json: '/search.json'
})
</script>
            </li>
            <li role="menuitem" class="navbar__nav-item">
            	<a href="/" class="navbar__nav-link" title="Sobre" role="link">Home</a>
            </li>
            <li role="menuitem" class="navbar__nav-item">
               <a href="/projetos" class="navbar__nav-link" title="Projetos" role="link">Projetos</a>
            </li>
            <li role="menuitem" class="navbar__nav-item">
               <a href="/colecoes" class="navbar__nav-link" title="Projetos" role="link">Coleções</a>
            </li>
            <!-- FOR para gerar os intens do menu. -->
            
			    
			 
			    
			    <li role="menuitem" class="navbar__nav-item">
			    	<a role="link" class="navbar__nav-link" href="/about" title="Sobre">Sobre</a>
			    </li>
			    
			 
			    
			 
			    
			 
			    
			 
			    
			 
			    
			 
			    
			 
			    
			 
			    
			 
			    
			 
			    
			 
			    
			 
         </ul>
      </nav>
      <!---->
   </div>
</header>


<a class="menu__mobile" id="nav-menu">
    <div id="menu"></div>
</a>
<nav id="nav">
    <div id="nav-list">
        <a href="/">Home</a>
        <a href="/projetos" title="Projetos" role="link">Projetos</a>
        
            
        
            
            <a href="/about" title="Sobre">Sobre</a>
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    </div>
</nav>
<header id="header" class="pageHeader pageHeader--background">
	<article itemscope="itemscope" itemtype="http://schema.org/NewsArticle" class="article">
		<figure itemprop="image" itemscope="itemscope" itemtype="http://schema.org/ImageObject" class="pageHeader__image">
			<meta itemprop="url" content="/img/posts/2017-07-17-relatorio-do-active-directory-com-powershell/banner.jpg">
			<img src="/img/posts/2017-07-17-relatorio-do-active-directory-com-powershell/banner.jpg" alt="Relatório do Active Directory com Powershell" />
		</figure>
		<div class="info-header">
			<h1 class="pageHeader__title">Relatório do Active Directory com Powershell</h1>
			<ol itemscope="itemscope" itemtype="http://schema.org/BreadcrumbList" class="breadcrumb">
				<li itemprop="itemListElement" itemscope="itemscope" itemtype="http://schema.org/ListItem" class="breadcrumb__item">
					<a  href="/" class="breadcrumb__link nuxt-link-active" title="Home" itemprop="item">
						<span itemprop="name">Home</span>
						<meta  itemprop="position" content="1">
					</a>
					<span class="breadcrumb__divider">»</span>
				</li>
				
				<li itemprop="itemListElement" itemscope="itemscope" itemtype="http://schema.org/ListItem" class="breadcrumb__item">
					<a class="breadcrumb__link nuxt-link-exact-active nuxt-link-active breadcrumb__link--active" title="Relatório do Active Directory com Powershell" itemprop="item" href="/relatorio-do-active-directory-com-powershell">
					<span itemprop="name">Relatório do Active Directory com Powershell</span>
					<meta itemprop="position" content="2">
					</a>
				</li>

			</ol>
			<p itemprop="description" class="pageHeader__description">Como fazer auditória de Active Directory usando o powershell.</p>
			<div class="pageHeader__meta">

				<span>Publicado em Julho de 2017 por <span itemprop="author">Andrey Glauzer</span>
			</div>
		</div>
	</span>
</header>

        

        <!-- Main content -->
    	  <div class="container">
          <div class="grid grid--1of2">
        			<article id="post-page">
	<div class="content">
		<h2 id="active-directory">Active Directory</h2>

<p>É sempre bom fazer auditoria dos servidores que você gerencia, para ter tudo documentado, e sempre que necessário já ter tudo pronto, e organizado.
Para facilitar um pouco essa questão eu criei alguns scripts em Powershell para facilitar essa minha tarefa de auditoria, aos poucos vou colocando todos os que eu já criei.
Esse primeiro é um bem simples que é justamente para ter controle dos usuários do <code class="highlighter-rouge">Active Directory</code>, coletando informações de senha nome, departamento entre outras coisas.</p>

<h2 id="ao-script">Ao script</h2>

<p>Primeiro antes de mais nada, é preciso definir algumas vaiáveis, então aqui eu estou colocando as variáveis que eu vou utilizar ao decorrer do script.</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$relatorio</span> <span class="o">=</span> <span class="nv">$null</span>
<span class="nv">$tabela</span> <span class="o">=</span> <span class="nv">$null</span>
<span class="nv">$data</span> <span class="o">=</span> <span class="nb">Get-Date</span> -format <span class="s2">"dd/MM/yyyy"</span>
<span class="nv">$arquivo</span> <span class="o">=</span> <span class="s2">"user-ad-list.html"</span>
<span class="nv">$total</span> <span class="o">=</span> <span class="o">(</span><span class="nb">Get-ADUser</span> -filter <span class="k">*</span><span class="o">)</span>.count <span class="c1"># Total de usuários que existem do AD</span>
<span class="nv">$dominio</span> <span class="o">=</span> <span class="o">(</span><span class="nb">Get-ADDomain</span><span class="o">)</span>.Forest <span class="c1"># Domínio</span>
<span class="nv">$analista</span> <span class="o">=</span> <span class="s2">"Andrey Glauzer"</span> <span class="c1"># Analista</span>
<span class="nv">$empresa</span> <span class="o">=</span> <span class="s2">"ECOFRESH"</span> <span class="c1"># Empresa</span></code></pre></figure>

<h3 id="importando-módulos-do-powershell">Importando módulos do powershell</h3>

<p>Para poder coletar todas as informações do <code class="highlighter-rouge">AD</code> vamos utilizar o módulo do powershell, para isso usamos.</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell">Import-Module ActiveDirectory</code></pre></figure>

<h3 id="coletando-e-filtrando-resultados">Coletando e filtrando resultados</h3>

<p>Aqui vamos coletar tudo, filtrando apenas os objetos que eu desejo.</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$usuarios</span> <span class="o">=</span> @<span class="o">(</span><span class="nb">Get-ADUser</span> -filter <span class="k">*</span> -Properties Company, SamAccountName, Name, Mail, Department, Title, PasswordNeverExpires, Enabled, Created<span class="o">)</span></code></pre></figure>

<p>E aqui eu vou selecionar os objetos que eu filtrei.</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$resultado</span> <span class="o">=</span> @<span class="o">(</span><span class="nv">$usuarios</span> | <span class="nb">Select-Object </span>Company, SamAccountName, Name, Mail, Department, Title, PasswordNeverExpires, Enabled, Created<span class="o">)</span></code></pre></figure>

<p>Vou ordenar o meu resultado pela company.</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$resultado</span> <span class="o">=</span> <span class="nv">$resultado</span> | <span class="nb">Sort</span> <span class="s2">"Company"</span></code></pre></figure>

<h3 id="convertendo-o-resultado-para-html">Convertendo o resultado para HTML</h3>

<p>E converter tudo para HTML.
$tabela += $resultado | ConvertTo-Html -Fragment
Aqui eu vou adicionar a minha personalização, da tabela e o formato que vou utilizar ela.</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$formatacao</span><span class="o">=</span>
		<span class="s2">"
		&lt;html&gt;
		&lt;body&gt;
		&lt;style&gt;
		BODY{font-family: Calibri; font-size: 12pt;margin: 0;border: 0;color:#2d3643;}
		TABLE{border-collapse: collapse; font-size: 12pt; text-align:center;margin-left:auto;margin-right:auto; width='1000px';}
		TH{border: 1px solid #c1c1c1;background: #0c59a0;padding: 5px;color: white;}
		TD{border: 1px solid rgba(210, 210, 210, 0.95);padding: 5px;}
		.total{padding: 0;font-weight: 300;color: #888;}
		.titulo{border:0 !important;}
		#header h3 {padding: 0;font-weight: 300;color: #888;}
		#header h1 {font-weight: 100 !important;color: #0c59a0;}
		#header a {text-decoration: none;color: #343434;display: inline-block;}
		#header span {font-weight: 700;}
		#header i{color: #0c59a0;font-size:1.5em;}
		footer .fa-heart{color:red;}
		figure {margin: 0;}
		#header a {margin: 0em;text-align: center;vertical-align: middle;}
		.animate {animation-name: LogoAnimate;animation-duration: .9s;}
		@keyframes LogoAnimate {from {transform: scale(0);opacity: 0;  }
		  50% {transform: scale(0);opacity: 0;  }
		  82.5% {transform: scale(1.03);animation-timing-function: ease-out;opacity: 1;}
		  to {transform: scale(1);}}
		   footer {background-color: #0c59a0;color: #FDFDFD;text-align: center;padding: 0.6667em 0;margin-top: 1em;}
		footer a {color:white;}
		&lt;/style&gt; 
		"</span>
<span class="nv">$titulo</span><span class="o">=</span>
		<span class="s2">"
		&lt;table width='100%' border='0' cellpadding='0' cellspacing='0'&gt;
		&lt;tr&gt;
		&lt;td class='titulo'&gt;
		&lt;header id='header'&gt;
			&lt;a class='teste' href='#'&gt;&lt;h1 class='animate'&gt;&lt;span&gt;Active Directory - Lista de Usu&amp;aacute;rios&lt;/span&gt;&lt;/h1&gt;&lt;/a&gt;
			&lt;h3&gt;Empresa: </span><span class="nv">$empresa</span><span class="s2"> - Dominio: </span><span class="nv">$dominio</span><span class="s2"> - Relatorio: </span><span class="nv">$data</span><span class="s2"> - Responsavel: </span><span class="nv">$analista</span><span class="s2">&lt;/h3&gt;
		&lt;/header&gt;
		&lt;/td&gt;
		&lt;/tr&gt;
		&lt;/table&gt;
		&lt;/body&gt;
		&lt;/html&gt;
		"</span>
<span class="nv">$footer</span><span class="o">=</span><span class="s2">"&lt;footer&gt;&lt;span&gt;Feito com muito cafe - Andrey Glauzer @2017&lt;/footer&gt;"</span></code></pre></figure>

<h3 id="formatando-o-resultado">Formatando o resultado</h3>

<p>Agora tenho que juntar tudo o que eu fiz, na ordem que eu desejo.</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$relatorio</span> <span class="o">=</span> <span class="nv">$formatacao</span> + <span class="nv">$titulo</span> + <span class="nv">$tabela</span> + <span class="nv">$footer</span></code></pre></figure>

<p>Novamente vou converter tudo para o HTML.</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$relatorio</span> | <span class="nb">Out-File</span> <span class="nv">$arquivo</span> -Encoding Utf8</code></pre></figure>

<p>E também vou salvar o resultado em CSV.</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$resultado</span> | <span class="nb">Sort </span>Company | <span class="nb">Export-Csv </span>ad-lista.csv -NoTypeInformation -Encoding Utf8</code></pre></figure>

<hr />

<h2 id="resultado">Resultado</h2>

<p>Com todo o scrip montado, vamos à parte que nos intereça, a execução dele. Para executar é possivel que você precisa habilitar a execução de scripts do powershell, para fazer isso, abra ele em modo de administrador e execute o comando à baixo:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nb">Set-ExecutionPolicy </span>RemoteSigned</code></pre></figure>

<p>Feito isso, partimos para a ação. Ao executar o script ele vai gerar dois arquivos no mesmo diretório onde ele está, um HTML e o outro CSV. Se tudo der certo, devemos receber o seguinte resultado.</p>

<p><img src="img/posts/2017-07-17-relatorio-do-active-directory-com-powershell/01.PNG" alt="Fluxograma do ambiênte" /></p>

<hr />

<p>É possivel ver o script completo no meu github <a href="https://github.com/andreyglauzer/reletorio-ad" class="link-exteno">Andrey Glauzer</a></p>

		<div id="coment" class="comments">
	<div class="content-coment">
		<h3 data-v-dd8644c2="">Comentários para: <span class="opacity">"Relatório do Active Directory com Powershell"</span></h3>
		<div id="disqus_thread"></div>
		<script>

		/**
		 *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
		 *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables */
		/*
		var disqus_config = function () {
		    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
		    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
		};
		*/
		(function() { // DON'T EDIT BELOW THIS LINE
		    var d = document, s = d.createElement('script');
		    s.src = '//andreyglauzer-1.disqus.com/embed.js';
		    s.setAttribute('data-timestamp', +new Date());
		    (d.head || d.body).appendChild(s);
		})();
		</script>
		<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                    
	</div>
</div>

<style type="text/css">

.comments{
    background-color: #fff;
    border-top: 1.12px solid rgba(64,71,86,.1);
    border-top: .07rem solid rgba(64,71,86,.1);
    padding: 30px 0 0;
    padding: 1.875rem 0 0;
    margin-top: 30px;
    margin-top: 1.875rem;

div.alinhamento-header-posts{
    padding-top: 3rem;
}

div#coment{
    background-color: #fff;
    padding: 30px 0;
    margin-top: 15px;
}
div.content-coment h3 span.opacity{
        opacity: .6;
    font-weight: 500;
}
div.content-coment{
    max-width: 768px;
    max-width: 48rem;
    display: block;
    margin:0 auto;
}
</style>
	</div>
</article>


          </div>
    		
    		  <!-- Definicação de paginação -->
          

    	  </div>
    	    
    	    <!-- Footer -->
    	    <footer>
	Made with ♥ by <a target="_blank" href="https:/github.com/andreyglauzer/">Andrey Glauzer</a>, using <a href="">Jekyll</a>. This is an open <a target="_blank" href="https:/github.com/andreyglauzer/andreyglauzer.github.io/">source code</a>. Version 1.1.0.
</footer>

	<!-- Analise -->

	<!-- Quantcast Tag -->
	<script type="text/javascript">
	var _qevents = _qevents || [];

	(function() {
	var elem = document.createElement('script');
	elem.src = (document.location.protocol == "https:" ? "https://secure" : "http://edge") + ".quantserve.com/quant.js";
	elem.async = true;
	elem.type = "text/javascript";
	var scpt = document.getElementsByTagName('script')[0];
	scpt.parentNode.insertBefore(elem, scpt);
	})();

	_qevents.push({
	qacct:"p-BTQDD6C697r5P"
	});
	</script>

	<noscript>
	<div style="display:none;">
	<img src="//pixel.quantserve.com/pixel/p-BTQDD6C697r5P.gif" border="0" height="1" width="1" alt="Quantcast"/>
	</div>
	</noscript>
	<!-- End Quantcast tag -->

    	    <!-- Script -->
          <script src="/js/main.js"></script>	

  	</div>
  </body>
</html>